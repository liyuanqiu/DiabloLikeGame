name: CI

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  build-and-test:
    runs-on: windows-latest

    permissions:
      contents: read

    strategy:
      matrix:
        configuration: [Debug, Release]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '01f602195983451bc83e72f4214af2cbc495aa94'

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Restore NuGet packages
      run: nuget restore DiabloLikeGame.sln

    - name: Build Solution
      run: |
        msbuild DiabloLikeGame.sln /p:Configuration=${{ matrix.configuration }} /p:Platform=x64 /p:VcpkgEnableManifest=true

    - name: Run Unit Tests
      run: |
        $testDll = "bin\x64\${{ matrix.configuration }}\DiabloLikeGameTests.dll"
        if (Test-Path $testDll) {
          $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          $vsPath = & $vsWhere -latest -property installationPath
          $vsTestPath = Join-Path $vsPath "Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe"
          if (Test-Path $vsTestPath) {
            & $vsTestPath $testDll /Platform:x64 /Logger:trx
          } else {
            Write-Host "VSTest not found at $vsTestPath"
            exit 1
          }
        } else {
          Write-Host "Test DLL not found at $testDll"
          exit 1
        }
      shell: pwsh

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.configuration }}
        path: '**/*.trx'
        if-no-files-found: warn

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      if: matrix.configuration == 'Release'
      with:
        name: DiabloLikeGame-${{ matrix.configuration }}-x64
        path: |
          bin/x64/${{ matrix.configuration }}/DiabloLikeGame.exe
          bin/x64/${{ matrix.configuration }}/*.dll
        if-no-files-found: warn

  release:
    needs: build-and-test
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
    - name: Download Release Artifacts
      uses: actions/download-artifact@v4.1.8
      with:
        name: DiabloLikeGame-Release-x64
        path: release

    - name: Create Release Archive
      run: |
        Compress-Archive -Path release\* -DestinationPath DiabloLikeGame-${{ github.ref_name }}-x64.zip
      shell: pwsh

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: DiabloLikeGame-${{ github.ref_name }}-x64.zip
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref_name, '-') }}
